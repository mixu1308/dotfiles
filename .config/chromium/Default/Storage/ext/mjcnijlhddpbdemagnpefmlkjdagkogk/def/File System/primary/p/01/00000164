<div  lang="en"><p nodeIndex="21">openSUSE&rsquo;s <a href="https://yast.github.io" nodeIndex="77">YaST</a> installer creates a detailed btrfs root filesystem configuration that has been designed to be flexible and secure while still efficient when used with tools like <a href="https://snapper.io" nodeIndex="78">Snapper</a>.</p>
<p nodeIndex="23">One of the overriding requirements is to provide a clearly defined &lsquo;root filesystem&rsquo; containing everything we care about for &lsquo;full system rollback&rsquo; (facilitated by snapper), while using subvolumes to exclude everything we <u nodeIndex="79">do not</u> want in the &lsquo;root filesystem&rsquo; so snapper does not accidentally destroy user data when rolling back the system and its&rsquo; applications. Details of our default subvolume layout can be found <a href="https://en.opensuse.org/SDB:BTRFS" nodeIndex="80">on the openSUSE wiki</a>.</p>
<p nodeIndex="24">However this does lead to complications for some advanced users who wish to recreate this manually, such as when doing complex system recovery, custom automated provisioning or other tinkering. (NOTE: for Full System Recovery it is often better to use a tool like <a href="https://en.opensuse.org/SDB:Disaster_Recovery" nodeIndex="81">ReaR</a>).</p>
<p nodeIndex="25">The below steps are the steps to manually create an openSUSE-style btrfs partition believed to be correct at time of writing (19 Jan 2018).</p>
<p nodeIndex="26">This guide should be valid for <strong nodeIndex="82">openSUSE Tumbleweed 20180117</strong>, <strong nodeIndex="83">openSUSE Leap 15</strong>, and <strong nodeIndex="84">SUSE Linux Enterprise 15</strong> or later. However care should be taken to double check for new or removed subvolumes in *SUSE distributions as this document gets older.</p>
<p nodeIndex="27">Older versions of SUSE distributions will need to adjust these instructions to handle the <a href="https://en.opensuse.org/SDB:BTRFS#Old_.2Fvar.2F.2A_subvolume_layout_.28pre_Jan_2018.29" nodeIndex="85">old /var/* subvolume layout</a> previously used.</p>
<p nodeIndex="28">It should go without saying that this guide should only be followed by people who feel that they know what they are doing. It&rsquo;s normally a lot easier to use openSUSE&rsquo;s default tools like YaST and ReaR.</p>
<h2 nodeIndex="29">Step-by-Step</h2>
<p nodeIndex="30">For this example we will use <code nodeIndex="86">/dev/sda</code> as our example disk and <code nodeIndex="87">/dev/sda1</code> as our example partition for a btrfs root filesystem.</p>
<p nodeIndex="31"><strong nodeIndex="88">1:</strong> Create a partition table and the partition to be used as our root filesystem using your favourite tool (eg. <code nodeIndex="89">yast</code>, <code nodeIndex="90">parted</code>, <code nodeIndex="91">fdisk</code>)</p>
<p nodeIndex="32"><strong nodeIndex="92">2:</strong> Format <code nodeIndex="93">/dev/sda1</code> with a btrfs filesystem</p>
<div class="highlight" nodeIndex="33">
<pre nodeIndex="34">
<code class="language-" data-lang="" nodeIndex="94">mkfs.btrfs /dev/sda1
</code>
</pre></div>
<p nodeIndex="35"><strong nodeIndex="95">3:</strong> Mount the new partition somewhere so we can work on it. We&rsquo;ll use <code nodeIndex="96">/mnt</code> in this example.</p>
<div class="highlight" nodeIndex="36">
<pre nodeIndex="37">
<code class="language-" data-lang="" nodeIndex="97">mount /dev/sda1 /mnt
</code>
</pre></div>
<p nodeIndex="38"><strong nodeIndex="98">4:</strong> Create the default subvolume layout (this assumes an intel architecture, the /boot/grub2/* paths are different for different architectures)</p>

<p nodeIndex="41"><strong nodeIndex="99">5:</strong> Disable copy-on-write for var to improve performance of any databases and VM images within</p>
<div class="highlight" nodeIndex="42">
<pre nodeIndex="43">
<code class="language-" data-lang="" nodeIndex="100">chattr +C /mnt/@/var
</code>
</pre></div>
<p nodeIndex="44"><strong nodeIndex="101">6:</strong> Create <code nodeIndex="102">/mnt/@/.snapshots/1/info.xml</code> file for snapper&rsquo;s configuration. Include the following content, replacing <code nodeIndex="103">$DATE</code> with the current system date/time.</p>
<div class="highlight" nodeIndex="45">
<pre nodeIndex="46">
<code class="language-" data-lang="" nodeIndex="104"><span class="cp" nodeIndex="105">&lt;?xml version="1.0"?&gt;</span>
<span class="nt" nodeIndex="106">&lt;snapshot&gt;</span>
  <span class="nt" nodeIndex="107">&lt;type&gt;</span>single<span class="nt" nodeIndex="108">&lt;/type&gt;</span>
  <span class="nt" nodeIndex="109">&lt;num&gt;</span>1<span class="nt" nodeIndex="110">&lt;/num&gt;</span>
  <span class="nt" nodeIndex="111">&lt;date&gt;</span>$DATE<span class="nt" nodeIndex="112">&lt;/date&gt;</span>
  <span class="nt" nodeIndex="113">&lt;description&gt;</span>first root filesystem<span class="nt" nodeIndex="114">&lt;/description&gt;</span>
<span class="nt" nodeIndex="115">&lt;/snapshot&gt;</span>
</code>
</pre></div>
<p nodeIndex="47"><strong nodeIndex="116">7:</strong> Set snapshot 1 as the default snapshot for your root file system, unmount it, and remount it.</p>

<p nodeIndex="50"><strong nodeIndex="117">8:</strong> You should be able to confirm the above worked by doing <code nodeIndex="118">ls /mnt</code> which should repond with an empty result.</p>
<p nodeIndex="51">Congratulations, at this point the filesystem is &lsquo;created&rsquo; with the correct structure. But you need to know how to mount it properly to make use of it.</p>
<p nodeIndex="52"><strong nodeIndex="119">9:</strong> You now need to create a skeleton of the filesystem to mount all of our subvolumes</p>

<p nodeIndex="55"><strong nodeIndex="120">10:</strong> Mount all of the subvolumes</p>

<p nodeIndex="58"><strong nodeIndex="121">11:</strong> You&rsquo;re done, you&rsquo;ve now successfully created an openSUSE-style btrfs root filesystem structure and mounted it for use. You can now use it for whatever you&rsquo;d like, such as the manual injection of files from an existing openSUSE installation.</p>
<p nodeIndex="59">Once populated, care should be made to ensure the <code nodeIndex="122">/mnt/etc/fstab</code> also includes the appropriate entries for each of the subvolumes except <code nodeIndex="123">@/.snapshots/1/snapshot</code> which should not be mounted as it provides your initial installed system.</p>
<p nodeIndex="60">Have a lot of fun</p>
</div>